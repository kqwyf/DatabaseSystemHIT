# 数据库系统

## 第1讲 初步认识数据库系统

### 表 (Table)

#### 表的术语

**表名**：表的名称。

**表标题（格式）**：每一列的列名。

**表内容（值）**：表的内容。

**行/元组/记录**：表中的一行。

**列/字段/属性/数据项**：表中的一列。列中分为**列名**与**列值**。

**关系模式**：表名与表标题的组合。

**表/关系**：表名、表标题与表内容的组合。

**数据库**：相互有关联关系的若干表的集合。

### 数据库系统（工作环境）

#### 构成五要素

**数据库(DB)**：相互有关联关系的数据的集合。

**数据库管理系统(DBMS)**：管理数据库的一种系统软件。

**数据库应用程序(DBAP)**：不同用户使用的完成某功能的应用程序。**通过DBMS来使用数据库**。

**数据库管理员(DBA)**：**直接使用DBMS**来创建与管理数据库的人员。

**计算机基本系统**：使得数据库系统能够正常运行的计算机系统。

### 数据库管理系统 (DBMS)

#### 功能（用户角度）

- **数据库定义**：定义数据库中表的**名称**、**标题（包括属性名称及对属性值的要求）**等。
  - DBMS提供一套**数据定义语言(DDL)**，用户使用DDL描述表的格式，并由DBMS创建数据库。
- **数据库操纵**：向数据库的表中增加/删除/更新数据，以及对数据进行查询/检索/统计等。
  - DBMS提供一套**数据操纵语言(DML)**，用户使用DML描述增、删、改、查等操作，并由DBMS执行。
- **数据库控制**：控制数据库中数据的使用，即用户权限。
  - DBMS提供一套**数据控制语言(DCL)**，用户使用DCL描述对数据库的控制，由DBMS实际进行控制。
- **数据库维护**：转储/恢复/重组/性能检测/分析等功能。
  - DBMS提供一系列用于维护数据库的程序，一般由数据库管理员使用和掌握。

#### 数据库语言

**数据定义语言(DDL)**：用于定义数据格式。

**数据操纵语言(DML)**：用于对数据进行操作。

**数据控制语言(DCL)**：用于对数据进行控制。

上述三种语言联合起来形成**SQL语言**，即结构化查询语言。

##### 特点

- 一条数据库语言语句相当于高级语言的一个或多个循环程序。
- 数据库语言分为**嵌入型**（可嵌入到高级语言中使用，高级语言在此称为宿主语言）、**交互型**（可与用户交互）、**双重型**。

#### 功能（系统角度）

从系统实现角度看，DBMS的功能为**形式→构造→自动化**。

一般而言，操作系统管理存储与缓冲区，DBMS管理索引/文件记录与操作实现算法。但**有一些DBMS可越过操作系统直接管理存储与缓冲区**。

DBMS在后台运行着一系列程序：

- **语言编译器**：将用数据库语言书写的内容翻译为DBMS可执行的命令。如DDL编译器。
- **查询优化与查询实现**：执行引擎及基本命令的不同执行算法，提高数据库检索速度。
- **数据存取与索引**：在存储器上高效存取数据。例如存储管理器，缓冲区管理区，索引/文件和记录管理器。
- **通信控制**：网络环境下操作数据库与传输数据。
- **事务管理**：提高可靠性，避免并发错误。
- **故障恢复**：使数据库自动恢复到故障发生前的正确状态。例如备份、运行日志操控。
- **安全性控制**：合法性检验，避免非授权非法用户访问数据库。
- **完整性控制**：检查数据及数据操作的正确性。
- **数据字典管理**：管理用户已经定义的信息。
- **应用程序接口**：使应用程序能够使用DBMS特定功能。
- **数据库数据装载、重组**
- **数据库性能分析**：统计运行过程中数据库的各种性能数据，便于优化。

## 第2讲 数据库系统的结构抽象与演变

### 数据库系统的标准结构

#### 数据（视图）与模式

**数据（视图）**：某一表现形式下表现出来的数据库中的数据。

**模式**：对数据库中数据进行的一种结构性描述。

#### 三级模式两层映像

数据库系统的标准结构包括**用户层次**、**概念层次**、**内部层次**。总结为如下三级模式，两层映像。

##### 三级模式

- **外部模式（用户模式）**：某一用户能够看到与处理的数据的结构描述，是全局数据的一部分。
- **概念模式（全局模式）**：从全局角度管理的数据的结构描述，包含相应的关联约束，体现数据间的内在本质联系。
- **内部模式（物理模式）**：存储在介质上的数据的结构描述，包含存储路径、存储方式、索引方式等。

通常，**模式**默认意为**全局模式**，**视图**默认意为**外部视图**。

##### 两层映像

- **E-C映像**（即External - Conceptual）：将外模式映射为概念模式，支持数据概念视图向外部视图的转换。
- **C-I映像**（即Conceptual - Internal）：将概念模式映射为内模式，支持数据概念视图向内部视图的转换。

DBMS通常允许**用户自定义三级模式**，而通过**程序自动实现两层映像**。

#### 两个独立性

使用数据库系统标准结构可获得两个独立性：

- **逻辑数据独立性**：概念模式变化时，可以不改变外部模式（只需改变E-C映像），从而无需改变应用程序。
- **物理数据独立性**：内部模式变化时，可以不改变概念模式（只需改变C-I映像），从而无需改变外部模式。

两个独立性的意义都在于不会因为存储结构与逻辑结构的变化而影响应用程序。

### 数据模型

**数据模型**：规定模式统一描述方式的模型，是对模式本身结构的抽象。

- **关系模型**：以**表**的形式组织数据。模式需包含表名及若干属性。
- **层次模型**：以**树**的形式组织数据。模式需以树形组织若干**实体型**，实体型间连线称为**系型**。
- **网状模型**：以**图**的形式组织数据。模型形式与层次模型相似，但允许每个节点有多个父节点与子节点。

其余还有面向对象模型、XML模型、NoSQL模型等。

### 数据库系统的演变与发展

#### 由文件系统到数据库

- 文件系统中，数据存取基本以**记录**为单位。
  - 优点：用户无需考虑文件存储的物理细节。
  - 缺点：数据的组织及语义与应用程序紧密相关；文件及文件的记录之间无联系。
- 数据库系统中，数据由DBMS统一存取。数据存取可以以**记录**为单位，也可以以**数据项**和**记录集合**为单位。
  - 意义：多个应用程序可共享数据及数据结构的操作；系统自动检查安全性、完整性和并发正确性；记录之间相互有关联。

#### 由层次模型数据库、网状模型数据库到关系数据库

- **第一代数据库**：**层次模型数据库**与**网状模型数据库**
  - 缺点：由指针系统维系，结构描述复杂；检索依赖于指针系统指示的路径；不能有效支持记录集合的操作。

- **第二代数据库**：**关系数据库**
  - 意义：结构描述简单；检索不依赖于路径信息或过程信息，支持非过程化的数据操作；有效支持记录集合的操作。

#### 由关系数据库到对象关系数据库、面向对象数据库

- 关系数据库需按**关系的第一范式**组织数据，即**数据项是不可再分**的。
- 对象-关系数据库以对象封装需分解的数据项（多值属性和复合属性）。面向对象数据库支持复杂的数据类型，数据封装与抽象数据结构，并支持面向对象的一些特性。
  - 意义：有效支持不满足关系第一范式的数据项。
- XML数据库被称为**半结构化数据库**，面向数据交换而提出，**数据**与**数据的语义**合并在一起存储处理。XML数据库在互联网中得到广泛应用。

#### 由多种多样的数据库到多数据库开放式互连

使用**开放数据库连接(ODBC)**与不同的DBMS交互，从而统一操作多种数据库。

## 第3讲 关系模型之基本概念

### 关系

**域**：一组值的集合，这组值具有相同的数据类型。域是列的取值范围。

**分量**：元组中的每一个值称为一个分量。

**关系**：一组域的笛卡尔积的子集（满足某种意义的子集）。

**属性名**：由于关系的不同列可能来自同一个域，故为每一列起一个名称，即属性名。注意**属性名与域名不同**。

**关系模式/表标题**：用于表示关系的结构，记为$R(A_1:D_1,A_2:D_2,\dots,A_n:D_n)$，可简记为$R(A_1,A_2,\dots,A_n)$。意为属性$A_i$对应于域$D_i$。其中$n$称作关系的**度**或**目**，关系中元组的数目称为关系的**基数**。在许多DBMS中，域一般直接说明为属性的类型、长度等。

**候选码/候选键**：能唯一标识任意一个元组的一个极小属性组（即从中去除任意一个属性便不满足这一性质）。当候选码由所有属性构成时，该关系称为**全码关系**。

**主码/主键**：当有多个候选码时，可以选定一个作为主码。

**主属性**：包含在任意一个候选码中的属性。

**外码/外键**：若一个属性组不是关系$R$的候选码，但与关系$S$的候选码相对应，则称该属性组为$R$的外码/外键。两个关系通常靠外码来连接。

#### 特性

- 关系的任意两个元组不能完全相同，但在现实应用中，**表可能并不完全遵守此特性**。
- **关系第一范式**：属性不可再分。**复合属性**（属性由多个子属性构成）和**多值属性**（同一元组中该属性有多个值）不符合关系第一范式。

### 关系模型

#### 关系模型的三要素

- **基本结构**：关系
- **关系操作**：
  - 基本操作：并，差，积，选择，投影。（有时也将“更名”操作视为基本操作之一）
  - 扩展操作：交，连接，除。
- **完整性约束**：包括**实体完整性**、**参照完整性**及**用户自定义的完整性**。其中，实体完整性和参照完整性由DBMS自动支持，用户自定义的完整性通常由DBMS在更新操作发生时自动检查。
  - **实体完整性**：主码中的属性值不能为空值（不知道或无意义的值，以“?”表示）。
  - **参照完整性**：外码要么取空值，要么取其对应主码关系中出现过的主码值。
  - **用户自定义的完整性**：用户针对具体应用定义的完整性约束条件。

## 第4讲 关系模型之关系代数

### 关系代数操作

#### 并相容性

- 两关系的属性数目相同。
- 两关系按顺序对应属性的域相同。

并、差、交操作需要操作对象满足**并相容性**。

#### 操作定义

- 集合操作：

  - **并（$\cup$）**：$R \cup S=\{t|t \in R \or t \in S\}$
  - **交（$\cap$）**：$R \cap S=\{t|t \in R \and t \in S\}$，或$R \cap S=R-(R-S)$
  - **差（$-$）**：$R-S=\{t|t \in R \and t \notin S\}$
  - **广义积（$\times$）**：$R \times S=\{<a_1,\dots,a_n,b_1,\dots,b_m>|<a_1,\dots,a_n> \in R \and <b_1,\dots,b_m> \in S\}$
    - 由于行位置无关性与列位置无关性，有$R \times S = S \times R$。

- 纯关系操作：

  - **投影（$\pi_A$）**：$\pi_{A_{i1},A_{i2},\dots,A_{ik}}(R)=\{<t[A_{i1}],t[A_{i2}]>,\dots,t[A_{ik}]|t \in R\}$

    - 投影结果的列顺序可以与原顺序不同。
    - 投影后若出现相同元组，应消除掉。
    - 下标若为关系名，则代指该关系拥有的属性；若为关系之差，则代指两关系的属性集之差。
  - **选择（$\sigma_{con}$）**：$\sigma_{con}(R)=\{t|t \in R \and con(t)=\rm{true}\}$

    - 书写条件时，元组$t$的分量$A_i$记为$t[A_i]$，或简写为$A_i$。
  - **连接**：

    - **$\theta$-连接（$\mathop \Join \limits_{A \space\theta\space B}$）**：$R \mathop \Join \limits_{A \space\theta\space B} S=\sigma_{t[A]\space\theta\space s[B]}(R \times S)$，其中$\theta$为比较运算符，$t \in R$，$s \in S$。
      - 一个关系与自身连接时应进行换名，例如$\rho_{S}R$表示将集合$R$换名为$S$。
    - **等值连接**：即特殊的$\theta$-连接，其中$\theta$为$=$。
    - **自然连接（$\Join$）**：$R \Join S=\sigma_{t[B]=s[B]}(R \times S)$，要求$R$与$S$中有若干个相同的属性（组）$B$。
      - 连接后去除重复属性列。
  - **除（$\div$）**：$R \div S=\{t[A]|t \in R \and \{t[A]\} \times S \subseteq R\}$，其中$A$为属于$R$但不属于$S$的属性（组）。
  - **外连接**：连接+失配的元组（与全空元组连接）
    - 分为左外连接、右外连接与全外连接，左/右代指保留哪个方向的失配元组，记号为相应方向多两横。

## 第5讲 关系模型之关系演算

关系演算按照谓词变量的不同，分为**关系元组演算**与**关系域演算**。

### 关系元组演算

关系元组演算表达式的基本形式：$\{t|P(t)\}$，表示所有使谓词$P$为真的元组$t$的集合。其中谓词$P$有递归定义，允许使用的运算符包括$\in$，$\theta$，$\neg$，$\and$，$\or$，$\exist()()$，$\forall()()$。其中，被存在量词$\exist$或全称量词$\forall$限定的元组变量称为**约束变量**，否则称为**自由变量**。

存在量词与全称量词的等价转换：

- $\forall(t \in R)(P(t)) \Leftrightarrow \neg (\exist (t \in P)(\neg P(t)))$
- $\exist(t \in R)(P(t)) \Leftrightarrow \neg (\forall (t \in P)(\neg P(t)))$

### 关系域演算

关系域演算表达式的基本形式：$\{<x_1,x_2,\dots,x_n>|P(x_1,x_2,\dots,x_n)\}$，表示所有使谓词$P$为真的域变量元组的集合。其中$x_i$为域变量或常量，$P$具有与关系元组演算公式相似的递归定义。

#### QBE语言

通过填表进行基于关系域演算的增删改查。

QBE操作框架四部分：关系名，属性名，操作命令，查询条件。

示例元素：用于连接多个条件。当两行间使用不同示例元素时表示或；当两行间使用相同示例元素时表示与；当两表中出现相同示例元素时表示连接两表中对应的属性。

操作命令也可写在查询条件区，表示仅操作该列；与或非运算符也可写在操作命令区，此时将整行看做一个条件（相当于加括号）。

### 关系运算的安全性

安全性：不产生**无限关系**和**无穷验证**的运算称为安全的。

关系代数是有限集合的运算，故是**安全**的；关系演算**不一定是安全**的。

**安全约束有限集合 (DOM) **：$\rm{DOM}(\psi)$是一个有限集，其中每个元素要么是公式$\psi$中的符号，要么是$\psi$中某关系中某元组的某分量。DOM不必是最小集合。

**安全元组演算表达式**：满足以下条件的元组演算表达式$\{t|\psi(t)\}$称为安全表达式。

- 若$t$满足$\psi$，则$t$的每个分量均属于$\rm{DOM}(\psi) $。（保证不产生无限关系）
- 对于$\psi$中形如$(\exist u)(\omega(u))$的子表达式，若$u$满足$\omega$，则$u$的每个分量均属于$\rm{DOM}(\omega)$。（保证不产生存在量词的无穷验证）
- 对于$\psi$中形如$(\forall u)(\omega(u))$的子表达式，若$u$不满足$\omega$，则$u$的每个分量均属于$\rm{DOM}(\omega)$。（保证不产生全称量词的无穷验证）

